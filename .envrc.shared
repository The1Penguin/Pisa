watch_file flake.{nix,lock}

_use_shell_rootd="$PWD"

# Wrapper for use flake
use_shell() {
  pushd "$_use_shell_rootd" >/dev/null || return 1
  DEVENV_ROOT_FILE="$(mktemp)"
  printf %s "$PWD" > "$DEVENV_ROOT_FILE"

  shell="$1"
  shift

  use flake ".#$shell" "$@" --override-input devenv-root "file+file://$DEVENV_ROOT_FILE" \
    || echo 'devenv could not be built. The devenv environment was not loaded.' >&2

  rm "$DEVENV_ROOT_FILE"
  popd >/dev/null || return 1
}
